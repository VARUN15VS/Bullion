<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BULLION</title>
    <link rel="stylesheet" href="modify_list.css">
</head>
<body>
    <div class="header">
            <div>
                <h1>BULLION</h1>
            </div>
            <div>
                <a href="home.html"><button class="home">Home</button></a>
                <a href="list.html"><button class="lists">Lists</button></a>
            </div>
    </div>
    <div class="list_name" id="list_name" style="margin-left: 50px;"></div>
    <div class="search-container">
            <input type="text" id="search" class="search" placeholder="Search for Stock">
            <button id="searchButton" class="searchButton" onclick="searchStocks()">Search</button>
        </div>
        <div class="result"></div>
    <div id="stocksdisplay" style="display: flex; flex-wrap: wrap; gap: 16px;"></div>
    <div class="deletelist">
        <button class="delete" onclick="delete_list()">Delete List</button>
    </div>
    <script>
        async function delete_list() {
            const params = new URLSearchParams(window.location.search);
            const listName = params.get("list");
            if (!listName) {
                alert("No list selected");
                return;
            }

            if (confirm(`Are you sure you want to delete the list: ${listName}? This action cannot be undone.`)) {
                try {
                    const res = await fetch(`http://127.0.0.1:5000/delete_list`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ list_name: listName })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        alert(`List ${listName} deleted`);
                        window.location.href = "list.html";
                    } else {
                        alert(data.message || "Failed to delete list");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Error connecting to server.");
                }
            }
        }

        async function searchStocks() {
            const query = document.getElementById("search").value.trim();
            const resultsDiv = document.querySelector(".result");

            if (!query) {
                resultsDiv.innerHTML = "<p>Please enter a stock name.</p>";
                return;
            }

            resultsDiv.innerHTML = "<p>Searching...</p>";

            try {
                const res = await fetch("http://127.0.0.1:5000/search", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: query })
                });
                const data = await res.json();
                if (!res.ok) {
                    resultsDiv.innerHTML = `<p>${data.error || "Something went wrong."}</p>`;
                    return;
                }
                if (data.results && data.results.length > 0) {
                    resultsDiv.innerHTML = "";
                    data.results.forEach(stock => {
                        const card = document.createElement("div");
                        card.className = "stock-card";

                        const header = document.createElement("div");
                        header.className = "stock-header";
                        header.innerHTML = `<h3>${stock.name}</h3>
                                            <span>NSE</span>`;

                        const token = document.createElement("p");
                        token.className = "stock-token";
                        token.textContent = `Token: ${stock.symboltoken}`;

                        const trading = document.createElement("p");
                        trading.className = "stock-symbol";
                        trading.innerHTML = `<strong>Symbol:</strong> ${stock.tradingsymbol}`;

                        const addButton = document.createElement("button");
                        addButton.className = "btn-add";
                        addButton.textContent = "Add to List";
                        addButton.onclick = () => addToList(stock);

                        card.appendChild(header);
                        card.appendChild(token);
                        card.appendChild(trading);
                        card.appendChild(addButton);

                        resultsDiv.appendChild(card);
                    });
                } else {
                    resultsDiv.innerHTML = "<p>No stocks found.</p>";
                }
            } catch (err) {
                console.error(err);
                resultsDiv.innerHTML = "<p>Error connecting to server.</p>";
            }
        }

        async function addToList(stock) {
            const params = new URLSearchParams(window.location.search);
            const listName = params.get("list");
            if (!listName) {
                alert("No list selected");
                return;
            }

            try {
                const res = await fetch(`http://127.0.0.1:5000/add_stock`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        list_name: listName,
                        trading_symbol: stock.tradingsymbol,
                        exchange: "NSE",
                        stock_name: stock.name,
                        symbol_token: stock.symboltoken
                    })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`${stock.tradingsymbol} added to ${listName}`);
                    window.location.reload();
                } else {
                    alert(data.message || "Failed to add stock");
                }
            } catch (err) {
                console.error(err);
                alert("Error connecting to server.");
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            const listName = params.get("list");
            if (!listName) {
                document.getElementById("stocksdisplay").innerHTML = "<p>No list selected</p>";
                return;
            }

            const listNameDiv = document.getElementById("list_name");
            listNameDiv.innerHTML = `<h2>List Name: ${listName}</h2>`;

            fetch(`http://127.0.0.1:5000/api/list/${encodeURIComponent(listName)}/stocks`)
                .then(response => response.json())
                .then(data => displayStocks(data))
                .catch(err => {
                    console.error("Error fetching stocks:", err);
                    document.getElementById("stocksdisplay").innerHTML = "<p>Error loading stocks</p>";
                });
        });

        function displayStocks(data) {
            const container = document.getElementById("stocksdisplay");
            container.innerHTML = "";

            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = "<p>No stocks found in this list</p>";
                return;
            }

            data.forEach(stock => {
                const card = document.createElement("div");
                card.className = "stock-card";

                const header = document.createElement("div");
                header.className = "stock-header";
                header.innerHTML = `<h3>${stock.stock_name}</h3>
                                    <span>${stock.exchange}</span>`;

                const token = document.createElement("p");
                token.className = "stock-token";
                token.textContent = `Token: ${stock.symbol_token}`;

                const trading = document.createElement("p");
                trading.className = "stock-symbol";
                trading.innerHTML = `<strong>Symbol:</strong> ${stock.trading_symbol}`;

                const btnContainer = document.createElement("div");
                btnContainer.className = "btn-container";

                const viewBtn = document.createElement("button");
                viewBtn.className = "btn-view";
                viewBtn.textContent = "View Chart";
                viewBtn.onclick = () => viewChart(stock);

                const deleteBtn = document.createElement("button");
                deleteBtn.className = "btn-delete";
                deleteBtn.textContent = "Delete";
                deleteBtn.onclick = () => deleteStock(stock);

                btnContainer.appendChild(viewBtn);
                btnContainer.appendChild(deleteBtn);

                card.appendChild(header);
                card.appendChild(token);
                card.appendChild(trading);
                card.appendChild(btnContainer);

                container.appendChild(card);
            });
        }

        function viewChart(stock) {
            const params = new URLSearchParams({
                trading_symbol: stock.trading_symbol,
                exchange: stock.exchange,
                stock_name: stock.stock_name
            });
            window.location.href = `chart.html?${params.toString()}`;
        }

        function deleteStock(stock) {
            if (confirm(`Are you sure you want to delete ${stock.trading_symbol}?`)) {
                alert(`${stock.trading_symbol} deleted`);
                
                const list_name = new URLSearchParams(window.location.search).get("list");
                const trading_symbol = stock.trading_symbol;
                fetch(`http://127.0.0.1:5000/delete_stock`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ list_name, trading_symbol })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`${trading_symbol} removed from list`);
                        window.location.reload();
                    } else {
                        alert(data.message || "Failed to delete stock");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Error connecting to server.");
                });
            }
        }
    </script>
</body>
</html>